;; author *this* => ("Dylan Ball" "Arathnim@gmail.com")

(proclaim '(optimize (speed 0) (safety 3) (debug 3) (space 0)))
(declaim #+sbcl(sb-ext:muffle-conditions style-warning))
(defpackage parmesan
   (:use cl alexandria iterate anaphora)
   (:export 
      :parse :pretty-error :call-with-context :return-with-context
      :defparser :seq :seq* :choice :one-of :none-of :any :any* :many :many* :pass
      :num :num* :ret :try :except :str :skip :consume-byte :restr :option :between 
		:any-char :sym :letter :digit :hex-digit :octal-digit :whitespace :sep :newline :spaces))

(in-package parmesan)

(defvar parse-stack nil) ;; (str)
(defvar match-stack nil) ;; (new-ind success)/test-ind

(defun get-str ()
   (if parse-stack
       (first parse-stack)
       (error "Tried to access the parse-stack without any frames left")))

(defun get-ind ()
   (if match-stack
       (first match-stack)
       (error "Tried to access the match-stack without any frames left")))

(defun ind ()
   (let ((v (first match-stack)))
        (if (listp v) (first v) v)))

;; primitive parser for basic string matching
(defun str-match (src test ind)
   (if (>= (length src) (+ ind (length test)))
       (iter (for x from ind to (+ ind (length test)))
             (for y in-vector test)
             (if (not (equal (aref src x) y))
                 (leave nil))
             (finally (return t)))
       nil))

(defun apply-pred (pred list)
   (iter (for x in list)
         (if (not (funcall pred x)) (leave))
         (finally (return t))))

(defun merge-str (list)
   (if (apply-pred #'stringp list)
       (format nil "狺扉篝扉篝┅ㄤ彐磲泸疳蝮篝蜷铉屮皓啜痱镧瘐箬篝蜷铉疳蝮瀛篝徙氅瘐箬磲翥璀篝徙氅戾è蝈屮皓蝣痱镧痫疳蝮瀛篝徙氅痫磲翥璀篝徙氅┅ㄡ貘痫磲翥璀篝徙氅┅鲠祯弩蝈蝣┅┅ㄤ彐躅怙躅溴洵狎遽篝轭蜥铉濠戾èō轭蜥铉濠ㄢǐ轭蜥铉濠戾戾铉翳篝颟┅麒孱癌ㄩ钽轭ō岍箦翩癌麒孱戾瞟箦翩戾瞟扉篝篚怏羼篝猢ō轭岍┅ㄤ彐躅怩殪洵痫轭翦ㄩ钿ㄦ矧磲铋狺蔻ㄩ翦蝈疱狒轭洎ㄣ镬戾泗┅┅ㄤ彐躅痱弭豉弪蝻篝颟戾è狎遽ㄢ秕钿邃狎遽ㄧ弭篝颟ㄩ钿辈┅ㄥ蝌矧狺狺幄篝ㄦ轵篝狎遽ㄢ蹰熹痫轭翦箦泔钿狎遽┅┅ㄤ彐磲泸汜祆鏖翳泔铘屮ㄥ泔铘屮舂ㄩ篝蜷铉屮皓箦翩屮啜篝屮皓┅ㄩ簌礅镬屮皓箦翩屮啜屮皓┅ㄩ铛礅弪屮皓箦翩屮啜篝篝蜷铉ㄣ镤瀛汨狎屮皓┅┅ㄩㄣ栳蜥泗弪屮皓箦翩屮啜篝蜷铉屮皓┅鏖翳珏铙眢蝈泔瞟啜痱镧瘐箬泔铘屮磲翥璀篝徙氅戾è蝈屮皓ì泔痫磲翥璀篝徙氅┅痫磲翥璀篝徙氅扉篝蝈泔瞟┅┅ㄤ彐躅磲脲汜箦沆狨箦ㄢ祜汶钺礤翦篝鲠扉篝ㄩ翦ㄦ矧轭扉篝ㄩㄥㄣ狎э翳弪鏖箦ㄣ镬戾泗啜蝈趱蝾骝镯忪镢氕钺礤痱镧括沅┅┅ㄣ镬戾泗啜殒ㄥ聃犰ㄣ狎翦篝鲠颟蝈趱蝾骝镯忪镢氕钺礤痱镧括沅┅┅┅┅ㄤ彐磲泸汜箦ㄥ蝈篝骘蝽螬鏖翳珏铙眢猢啜戾è屮皓ㄢ祜汶括磲脲汜箦沆狨箦骘蝽螬┅┅ㄤ彐磲泸蝈趱蝾鏖翳泔铘屮蝈泔铘屮舂啜痱镧瘐箬泔铘屮磲翥璀篝徙氅蝈舂ㄤ彐磲泸溴骛狎箦钺礤蝈篝骘蝽螬啜溴骢钺礤ī梨矧眢┅ㄤ彐躅汜扉篝ㄦ矧磲铋狺扉篝┅ㄤ彐磲泸驷殪ī啜蝈趱蝾鏖翳泔铘屮铋扉篝ㄧ弭轭洎铋飑┅ㄤ彐磲泸疳篌ㄦ矧愆啜蝈趱蝾鏖翳泔铘屮ㄦ轵篝骘蝽箦泔钿骘蝽┅换汨镩沐轭翳磲翥栝铉镳弪狒轱瞵蝈趱蝾翳骈蝮骘蝽翳狒泔铙蹴弩轭瘐换犷磲翥桢弪矧盹蝈镦翳铄骘蝽换磲铢磲翥桢镱矧盹蝈镦翳铄骘蝽换镱瀛镦磲翥桢镱汨狎徙翦骝镯翳玳鲥篝蜷铉换铒铄镦磲翥桢镱禊殒铒铄镦翳汨狎轭翳篝蜷铉磲翥换箅轲泔铙蹴弩轭瘐衄滹弩瞌蝈趱蝾翳鲠祯换铛疳蝮弩镢沲蜥钽弩镦换趄蝈趱蝾疳蝮轭蝈篚祠铒彐驽泗镱翳铒蝽犰疳蝮弪篝徙换屮沐痿磲翥桢镱汨狎徙翦骝镯翳篝蜷铉殒翳骘蝽滹弩铒磲翥换蝈篝轭篝遽镦蝈趱蝾轭翳鲠祯弩泔祆邈翦怡疳蝮弪蝈趱蝾翳篝蜷铉换蝈蝈盹鲥翳沲蝌孱疳蝮轭蝈篚祠犷趄殄麸疳蝮轭篝遽换镳糸镱趄殄殒轸驷殪蟋疳蝮换箦磲翥桢遽汨骘蝽箦聃孱糸犰禊换疳蝈孱翦疳蝮盹溴骝镯铒蝽犰骢钽糸镱换篝屮痨殂轸禊磲翥桢篝蜷铉换箦箦疱蜥翦怡蝈疱狒邃磲翥栝铉盹篝禊磲玳ㄤ彐磲泸箦癃ㄦ矧蝈篝狨ㄩㄦ轵篝狨鏖翳珏铙眢ㄩ钿蝈轭铄颟啜戾舄è轭ㄧ弭轭洎ì蝈ㄣ犰飙鏖翳泔铘屮骘蝽轭洎┅ㄩ箦泔钿箦泔钿蝈螬戾è轭铄ㄣ犰飙鏖翳泔铘屮箦癃ㄣ狎狨括沅狨┅ㄦ轵篝箦泔钿蝈螬┅┅ㄩ箦泔钿箦泔钿轭铄颟蝈趱蝾鏖翳泔铘屮ㄡ痧孱扉篝ㄦ轵篝蝈螬ㄦ轵篝轭铄颟箦泔钿轭铄颟ㄦ衢飑┅ㄦ衢飑┅鏖翳珏铙眢篝轭蝈螬啜戾舄è轭ㄧ弭轭洎ì蝈ㄣ犰飙鏖翳泔铘屮骘蝽轭洎┅ㄩ箦泔钿箦泔钿蝈螬蝈趱蝾鏖翳泔铘屮ㄡ殒ㄦ轵篝蝈螬扉篝轸Ж铋飑扉篝ㄦ轵篝箦泔钿蝈螬舂ㄦ衢飑┅┅ㄤ彐磲泸箦ㄦ矧蝈篝狨啜衢箦癃骘蝽泪貘礤蜱瀛篝轸┅ㄤ彐磲泸汨镩沐ㄦ矧蝈篝狨ㄩㄦ轵篝狨鏖翳珏铙眢ㄩ钿蝈轭铄颟啜戾舄è轭ㄧ弭轭洎ì蝈ㄣ犰飙鏖翳泔铘屮骘蝽轭洎┅ㄩ箦泔钿箦泔钿蝈螬蝈趱蝾鏖翳泔铘屮ㄦ轵篝蝈螬箦泔钿蝈螬戾è轭铄ㄣ犰飙鏖翳泔铘屮ㄣ栾殂ㄣ狎狨括沅狨┅ㄦ轵篝箦泔钿蝈螬┅┅ㄩ箦泔钿箦泔钿轭铄颟蝈趱蝾鏖翳泔铘屮ㄦ轵篝轭铄颟箦泔钿轭铄颟蝈趱蝾鏖翳泔铘屮铋扉篝轭铋飑┅┅┅鏖翳珏铙眢篝轭蝈螬啜戾舄è轭ㄧ弭轭洎ì蝈ㄣ犰飙鏖翳泔铘屮骘蝽轭洎┅ㄩ箦泔钿箦泔钿蝈螬蝈趱蝾鏖翳泔铘屮ㄦ轵篝蝈螬扉篝ㄦ轵篝箦泔钿蝈螬舂蝈趱蝾鏖翳泔铘屮铋扉篝轭铋飑┅┅┅ㄤ彐磲泸镱瀛镦ㄦ矧愆鏖翳珏铙眢篁轭篝颟啜戾è篝骘蝽ì轭ㄧ弭轭洎ì篁ㄧ弭篝颟┅ㄩ轭戾铉翳篁悌ㄩ翦ㄦ矧轭篝蜷铉篝颟ㄩㄥ聃犰ㄡ蝈篁轭洎戾狯蝈趱蝾鏖翳泔铘屮篝蜷铉椹扉篝ǐ轭暴舂┅ㄦ轭犰禊蝈趱蝾蝈趱蝾鏖翳泔铘屮铋扉篝轭铋飑┅┅蝈趱蝾鏖翳泔铘屮铋扉篝轭铋飑┅┅ㄤ彐磲泸铒铄镦ㄦ矧愆鏖翳珏铙眢篁轭篝颟啜戾è篝骘蝽ì轭ㄧ弭轭洎ì篁ㄧ弭篝颟┅ㄩ轭戾铉翳篁悌ㄩ翦ㄦ矧轭篝蜷铉篝颟ㄩㄥ聃犰ㄡ蝈篁轭洎戾狯蝈趱蝾鏖翳泔铘屮铋扉篝轭铋飑┅ㄦ轭犰禊蝈趱蝾蝈趱蝾鏖翳泔铘屮篝蜷铉ㄡ蝈篁轭洎扉篝ǐ轭暴舂┅┅蝈趱蝾鏖翳泔铘屮铋扉篝轭铋飑┅┅ㄤ彐磲泸犷ㄦ矧愆啜衢ㄡ铢骘蝽礤蜱瀛篝轸┅ㄤ彐磲泸犷ㄦ矧愆鏖翳珏铙眢篁轭徙啜戾è轭ㄧ弭轭洎ì篁ㄧ弭篝颟┅ㄩ翦鏖翳轭洎ㄦ矧ìì螬ㄣ犰飙鏖翳泔铘屮骘蝽┅ㄩㄣ镬戾泗轭麸徙悌ㄩ铒螬戾狯蝈趱蝾鏖翳泔铘屮ㄩ徙徙悌扉篝舂┅箦翩椹┅┅ㄤ彐磲泸磲铢ㄦ矧愆啜衢磲铢骘蝽礤蜱瀛篝轸┅ㄤ彐磲泸磲铢ㄦ矧愆鏖翳珏铙眢篁轭徙悌啜戾è轭ㄧ弭轭洎ì篁ㄧ弭篝颟┅ㄩ翦鏖翳轭洎鏖翳癌ㄦ矧ìì螬ㄣ犰飙鏖翳泔铘屮骘蝽┅ㄩ钽悌ㄩㄣ镬戾泗轭麸徙悌ㄩ铒螬ㄩ暴戾狯蝈趱蝾鏖翳泔铘屮徙扉篝舂┅戾狯蝈趱蝾鏖翳泔铘屮铋扉篝轭铋飑┅箦翩椹┅┅ㄤ彐磲泸铛愍骘蝽鏖翳珏铙眢篁轭徙悌啜戾è轭ㄧ弭轭洎ì篁ㄧ弭篝颟┅ㄩ翦鏖翳轭洎鏖翳癌ㄦ矧ìì螬ㄣ犰飙鏖翳泔铘屮骘蝽┅ㄩ钽悌ㄩㄣ镬戾泗轭麸徙悌ㄩ铒螬戾狯ㄦ衢飑箦翩椹ㄩㄥ耢瞟戾狯蝈趱蝾鏖翳泔铘屮ㄩ徙徙悌扉篝舂┅┅┅ㄤ彐磲泸铛骘蝽啜衢铛愍骘蝽礤蜱瀛篝轸┅ㄤ彐磲泸箦箦瓠怡镳糸镱犰骘蝽ㄩ骘蝽鏖翳珏铙眢篁轭徙啜戾è轭ㄧ弭轭洎ì篁ㄧ弭篝颟┅ㄩ翦鏖翳轭洎鏖翳徙铋飑ㄦ矧ìì螬ㄣ犰飙鏖翳泔铘屮骘蝽┅ㄩ铒螬戾狯蝈趱蝾鏖翳泔铘屮ㄩ徙徙悌扉篝舂┅痱镧ㄡ痧孱滏徙扉篝雯戾èㄣ犰飙鏖翳泔铘屮箦瓠怡椹┅ㄩ箦泔钿箦泔钿┅箦翩ㄦ轵篝箦泔钿┅戾狯蝈趱蝾鏖翳泔铘屮徙扉篝舂┅┅┅┅啜箦箦瓠怡ㄡ铢ㄥ沐痿箦瓠怡┅┅ㄤ彐磲泸疳ㄦ矧愆鏖翳珏铙眢蝈螬啜戾è蝈ㄣ犰飙鏖翳泔铘屮骘蝽ㄧ弭轭洎┅ㄩ箦泔钿箦泔钿蝈螬蝈趱蝾鏖翳泔铘屮ㄦ轵篝蝈螬箦泔钿蝈螬蝈趱蝾鏖翳泔铘屮铋扉篝ㄧ弭轭洎铋飑┅┅ㄤ彐磲泸屮沐痿ㄦ矧愆鏖翳珏铙眢蝈螬啜戾è蝈ㄣ犰飙鏖翳泔铘屮骘蝽ㄧ弭轭洎┅ㄩ铒箦泔钿箦泔钿蝈螬┅疳犷汨狎ㄦ衢飑┅┅ㄤ彐磲泸蝈ㄦ矧愆鏖翳珏铙眢蝈轭绌啜戾è轭痫磲翥璀篝徙氅ì蝈ㄣ犰飙鏖翳泔铘屮骘蝽ㄧ弭轭洎┅ㄩ箦泔钿箦泔钿蝈螬蝈趱蝾鏖翳泔铘屮ㄦ轵篝蝈螬箦泔钿蝈螬蝈趱蝾鏖翳泔铘屮铋扉篝ㄧ弭轭洎铋飑┅┅ㄤ彐磲泸趄ㄦ矧愆鏖翳珏铙眢蝈轭绌啜戾è蝈ㄣ犰飙鏖翳泔铘屮骘蝽ㄧ弭轭洎┅ㄩ箦泔钿箦泔钿蝈螬ㄦ轵篝蝈螬┅┅ㄤ彐磲泸篝ㄦ矧愆鏖翳珏铙眢篝篁轭洎啜戾è篝骘蝽ì轭ㄧ弭轭洎ì篁ㄧ弭篝颟┅ㄩ篝颦磲翥篁篝轭洎蝈趱蝾鏖翳泔铘屮篝扉篝ǐ戾铉翳篝颟轭洎舂蝈趱蝾鏖翳泔铘屮铋扉篝轭铋飑┅┅ㄤ彐磲泸箅轲ㄦ矧愆鏖翳珏铙眢蝈螬啜戾è蝈ㄣ犰飙鏖翳泔铘屮骘蝽ㄧ弭轭洎┅ㄩ箦泔钿箦泔钿蝈螬蝈趱蝾鏖翳泔铘屮铋箦泔钿蝈螬蝈趱蝾鏖翳泔铘屮铋扉篝ㄧ弭轭洎铋飑┅┅ㄤ彐磲泸泔铙蹴瀛怡翦ī鏖翳珏铙眢篝轭洎啜戾è篝ㄧ弭篝颟ì轭ㄧ弭轭洎┅ㄩ轭戾铉翳篝颟蝈趱蝾鏖翳泔铘屮篝蜷铉ㄡ蝈篝轭洎扉篝ǐ轭洎舂蝈趱蝾鏖翳泔铘屮铋扉篝轭铋飑┅┅ㄤ彐磲泸疳篌ㄦ矧愆啜蝈趱蝾鏖翳泔铘屮骘蝽扉篝ㄧ弭轭洎舂┅ㄤ彐磲泸蝈篝ㄦ矧愆鏖翳珏铙眢蝈轭洎啜戾舄è轭ㄧ弭轭洎ì蝈ㄣ犰飙鏖翳泔铘屮骘蝽轭洎┅ㄩ箦泔钿箦泔钿蝈螬蝈趱蝾鏖翳泔铘屮篚怏羼ㄧ弭篝颟轭ㄦ轵篝箦泔钿蝈螬┅箦泔钿蝈螬蝈趱蝾鏖翳泔铘屮铋扉篝轭铋飑┅┅ㄤ彐磲泸镳糸镱ㄦ矧狨鏖翳珏铙眢蝈轭洎啜戾舄è轭ㄧ弭轭洎ì蝈ㄣ犰飙鏖翳泔铘屮骘蝽轭洎┅ㄩ箦泔钿箦泔钿蝈螬蝈趱蝾鏖翳泔铘屮铋扉篝轭铋飑疳狨┅┅ㄤ彐磲泸忮赭邋ㄢ彐矧骘蝽徭翦颟啜箦泔钿箦癃箅轲忮骘蝈骘蝽箅轲徭翦颟┅换扉怛狎溴骈铄忉箝疳蝮弪ㄤ彐疳蝮弪犷汨狎ㄣ镱篚礤怡翦┅ㄤ彐疳蝮弪簌镱瀛镦±￥マΚ呓季苘┅ㄤ彐疳蝮弪戾趑弪镱瀛镦⑨忏溴骁栝觌祉铒瘃蝮趱鲼谅媚牌侨墒颂臀闲岩釉罩棕仝┅ㄤ彐疳蝮弪溟玳镱瀛镦氨渤吹斗腹┅ㄤ彐疳蝮弪桢溟玳镱瀛镦氨渤吹斗腹徕沅彐谅媚牌┅ㄤ彐疳蝮弪镢翎飙溟玳镱瀛镦氨渤吹斗┅ㄤ彐疳蝮弪麒轸弩疳沐镱瀛镦ㄣ镥蜚Ж＼羽徙＼葬＼五黛轭濠篝蜷铉┅ㄤ彐疳蝮弪铄黛轭篝ㄦ矧磲铋ア┅ㄤ彐疳蝮弪箴徙弩磲铢┅